---
description: designing database schema or creating migrations
globs: 
alwaysApply: false
---

# ğŸ“— **Comprehensive Database Schema & Naming Decision Tree**

## ğŸ¯ **Goals:**
- Explicitly clear, intuitive, self-documenting naming conventions.
- Zero data duplication; simplest possible row-level security (RLS).
- Explicitly unified treatments/outcomes as **variables**.
- Explicitly unified numeric time-series data as **measurements**.
- No ambiguous prefixes (`user_`) in naming.
- Intermediate relational tables explicitly named by ownership relationship (`parent_child`).
- Avoid overly complex or overloaded schemas.

---

## ğŸŒ³ **Step 1: Schema Selection Decision Tree**

Explicitly choose a schema for each new data object:

```
Given a new data object, does it store:
â”‚
â”œâ”€ ğŸ“š Static, universal metadata explicitly?
â”‚   â””â”€ YES â†’ schema = reference
â”‚
â”œâ”€ ğŸŒ Aggregated anonymous statistical summaries explicitly?
â”‚   â”œâ”€ Aggregated across ALL users explicitly â†’ schema = global
â”‚   â””â”€ Aggregated across explicitly defined subsets/groups â†’ schema = cohort
â”‚
â”œâ”€ ğŸ§ª Defined multi-user studies/trials/protocol definitions explicitly?
â”‚   â””â”€ YES â†’ schema = cohort
â”‚
â”œâ”€ ğŸ‘¤ Individual user-specific data or single-user (N=1) trials explicitly?
â”‚   â””â”€ YES â†’ schema = personal
â”‚
â”œâ”€ ğŸ” Internal admin, authentication, or auditing explicitly?
â”‚   â””â”€ YES â†’ schema = core
â”‚
â”œâ”€ ğŸ’³ Commerce, transactions, inventory explicitly?
â”‚   â””â”€ YES â†’ schema = commerce
â”‚
â””â”€ âš ï¸ Unclear explicitly?
    â””â”€ Explicitly reconsider and redefine clearly.
```

---

## ğŸ›¢ï¸ **Step 2: Table vs. View Decision**

```
- Original/raw data stored explicitly â†’ TABLE
- Derived/calculated explicitly â†’ VIEW (Materialized if performance-critical)
```

---

## ğŸ“ **Step 3: Naming Conventions**

Explicitly use clear nouns without schema repetition or prefixes:

| Schema    | Recommended Names                                              |
|-----------|-------------------------------------------------------------------------|
| reference | `variables`, `units_of_measurement`, `variable_synonyms`                |
| global    | `treatment_rankings`, `variable_effectiveness`, `variable_global_stats` |
| cohort    | `trials`, `trial_phases`, `protocols`, `outcomes`, `trial_group_stats`  |
| personal  | `trials`, `trial_phases`, `measurements`, `variable_user_stats`         |
| core      | `users`, `audit_logs`, `permissions`                                    |
| commerce  | `orders`, `inventory`, `transactions`                                   |

**Rule:** Never prefix tables with `user_`.

---

## ğŸ”— **Step 4: Intermediate Relational Table Rules**

Explicitly name relational tables as `[parent_entity]_[child_entity]` (no alphabetical ordering):

| Schema    | Intermediate Tables (clear ownership order)     |
|-----------|----------------------------------------------------------|
| reference | `variables_synonyms`, `variables_ingredients`            |
| cohort    | `trials_participants`, `protocols_variables`             |
| personal  | `users_variables`, `trials_variables`                    |
| core      | `groups_users`, `permissions_users`                      |
| commerce  | `orders_products`, `shipments_orders`                    |

**Explicitly remove redundant `participants` table** unless explicitly needed for additional participant metadata.

---

## âš™ï¸ **Step 5: Handling of User-Specific Variable Settings**

- For minimal user settings explicitly store directly in relational tables (`users_variables`).
- **If extensive settings exist**, explicitly separate into:
  ```sql
  personal.variable_settings (
      user_id,
      variable_id,
      tracking_enabled,
      reminder_frequency,
      preferred_display_unit_id,
      goal_value,
      PRIMARY KEY (user_id, variable_id)
  )
  ```

- Explicitly avoid `personal.variables` table as redundant.

---

## ğŸ”‘ **Step 6: Unified Data Handling**

Explicitly unify treatments, outcomes, biomarkers as `variables`.

Explicitly unify numeric time-series data as `measurements`.

```sql
reference.variables
  (variable_id, name, category, default_unit_id, description)

personal.measurements
  (measurement_id, user_id, variable_id, timestamp, value)
```

---

## ğŸ“Š **Step 7: Outcome Rankings & Derived View Naming**

Explicitly standardized naming convention for derived outcome views:

- Global stats: explicitly suffix `_global_stats`
- Cohort stats: explicitly suffix `_group_stats`
- Personal stats: explicitly suffix `_user_stats`

Examples explicitly:

| Schema   | Derived Views                           |
|----------|--------------------------------------------------|
| global   | `treatment_rankings`, `variable_global_stats`    |
| cohort   | `trial_outcome_group_stats`, `variable_group_stats` |
| personal | `variable_user_stats`                            |

---

## ğŸ›¡ï¸ **Step 8: Row-Level Security (RLS)**

Explicitly simplified RLS per schema:

| Schema    | RLS Rules                              |
|-----------|-------------------------------------------------|
| reference | Public read-only explicitly                     |
| global    | Public read-only explicitly aggregated          |
| cohort    | Restricted explicitly to study participants/admin|
| personal  | User-private explicitly, optionally shareable   |
| core      | Internal/admin-only explicitly                  |
| commerce  | Customer(s)/admin explicitly                    |

---

## âš–ï¸ **Step 9: Measurement Unit Enforcement**

- Explicitly store all measurements only in global default unit (`reference.variables.default_unit_id`).
- Explicitly enforce conversion before insertion.
- Explicitly no alternate units stored.

---

## ğŸ“‹ **Checklist**

Verify explicitly for every new table/view:

âœ… Schema explicitly selected from decision tree.  
âœ… Table or view explicitly chosen.  
âœ… naming without prefixes explicitly followed.  
âœ… `[parent_child]` relational table naming explicitly used.  
âœ… Unified variable & measurement handling.  
âœ… Explicitly simplify user variable settings (within relational or dedicated table).  
âœ… Explicitly enforce default units explicitly.  
âœ… RLS explicitly clear and simple.

---

## ğŸ—‚ï¸ **Schema Structure**

```
supabase/
â””â”€â”€ migrations/
    â”œâ”€â”€ reference/          # schema = reference
        â”œâ”€â”€ variables
        â”œâ”€â”€ variables_synonyms
        â””â”€â”€ units_of_measurement
    â”œâ”€â”€ global/            # schema = global
        â”œâ”€â”€ treatment_rankings
        â””â”€â”€ variable_global_stats
    â”œâ”€â”€ cohort/           # schema = cohort
        â”œâ”€â”€ trials
        â”œâ”€â”€ trial_phases
        â”œâ”€â”€ protocols
        â”œâ”€â”€ outcomes
        â”œâ”€â”€ trials_participants
        â”œâ”€â”€ protocols_variables
        â””â”€â”€ variable_group_stats
    â”œâ”€â”€ personal/         # schema = personal
        â”œâ”€â”€ trials
        â”œâ”€â”€ trial_phases
        â”œâ”€â”€ measurements
        â”œâ”€â”€ users_variables (with minimal user settings)
        â””â”€â”€ variable_user_stats
    â”œâ”€â”€ core/            # schema = core
        â”œâ”€â”€ users
        â”œâ”€â”€ audit_logs
        â”œâ”€â”€ permissions
        â”œâ”€â”€ groups_users
        â””â”€â”€ permissions_users
    â””â”€â”€ commerce/        # schema = commerce
        â”œâ”€â”€ orders
        â”œâ”€â”€ inventory
        â”œâ”€â”€ orders_products
        â””â”€â”€ shipments_orders
```
